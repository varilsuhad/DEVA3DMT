% © 2020–2025 Deniz Varılsüha — Non-commercial research use only. See LICENSE.
% Contact: deniz.varilsuha@itu.edu.tr
function [RN,N,M] = rotNUnF(lx,ly,lz,J,a,b,c,RN,N,M)

s1=J(1,1);
s2=J(2,1);
s3=J(3,1);
r1=J(1,2);
r2=J(2,2);
r3=J(3,2);
t1=J(1,3);
t2=J(2,3);
t3=J(3,3);


n1=lx(1)/8*(1-b)*(1-c);
n2=lx(2)/8*(1+b)*(1-c);
n3=lx(3)/8*(1-b)*(1+c);
n4=lx(4)/8*(1+b)*(1+c);

N(1,1)=n1*s1; N(1,2)=n1*s2;  N(1,3)=n1*s3;
N(2,1)=n2*s1; N(2,2)=n2*s2;  N(2,3)=n2*s3;
N(3,1)=n3*s1; N(3,2)=n3*s2;  N(3,3)=n3*s3;
N(4,1)=n4*s1; N(4,2)=n4*s2;  N(4,3)=n4*s3;


q1=-r1-t1+b*t1+c*r1;
q2=r1-t1-b*t1-c*r1;
q3=-r1+t1-b*t1-c*r1;
q4=r1+t1+b*t1+c*r1;

w1=-r2-t2+b*t2+c*r2;
w2=r2-t2-b*t2-c*r2;
w3=-r2+t2-b*t2-c*r2;
w4=r2+t2+b*t2+c*r2;

e1=-r3-t3+b*t3+c*r3;
e2=r3-t3-b*t3-c*r3;
e3=-r3+t3-b*t3-c*r3;
e4=r3+t3+b*t3+c*r3;

% q w e
% s1 s2 s3
k1=lx(1)/8; k2=lx(2)/8; k3=lx(3)/8; k4=lx(4)/8;
RN(1,1)=(w1*s3-e1*s2)*k1; RN(1,2)=(e1*s1-q1*s3)*k1; RN(1,3)=(q1*s2-w1*s1)*k1;
RN(2,1)=(w2*s3-e2*s2)*k2; RN(2,2)=(e2*s1-q2*s3)*k2; RN(2,3)=(q2*s2-w2*s1)*k2;
RN(3,1)=(w3*s3-e3*s2)*k3; RN(3,2)=(e3*s1-q3*s3)*k3; RN(3,3)=(q3*s2-w3*s1)*k3;
RN(4,1)=(w4*s3-e4*s2)*k4; RN(4,2)=(e4*s1-q4*s3)*k4; RN(4,3)=(q4*s2-w4*s1)*k4;

%Ex


n1=ly(1)/8*(1-a)*(1-c);
n2=ly(2)/8*(1-a)*(1+c);
n3=ly(3)/8*(1+a)*(1-c);
n4=ly(4)/8*(1+a)*(1+c);

N(5,1)=n1*r1; N(5,2)=n1*r2;  N(5,3)=n1*r3;
N(6,1)=n2*r1; N(6,2)=n2*r2;  N(6,3)=n2*r3;
N(7,1)=n3*r1; N(7,2)=n3*r2;  N(7,3)=n3*r3;
N(8,1)=n4*r1; N(8,2)=n4*r2;  N(8,3)=n4*r3;


q1=-s1-t1+a*t1+c*s1;
q2=-s1+t1-a*t1-c*s1;
q3=s1-t1-a*t1-c*s1;
q4=s1+t1+a*t1+c*s1;

w1=-s2-t2+a*t2+c*s2;
w2=-s2+t2-a*t2-c*s2;
w3=s2-t2-a*t2-c*s2;
w4=s2+t2+a*t2+c*s2;

e1=-s3-t3+a*t3+c*s3;
e2=-s3+t3-a*t3-c*s3;
e3=s3-t3-a*t3-c*s3;
e4=s3+t3+a*t3+c*s3;

% q w e
% r1 r2 r3
k1=ly(1)/8; k2=ly(2)/8; k3=ly(3)/8; k4=ly(4)/8;
RN(5,1)=(w1*r3-e1*r2)*k1; RN(5,2)=(e1*r1-q1*r3)*k1; RN(5,3)=(q1*r2-w1*r1)*k1;
RN(6,1)=(w2*r3-e2*r2)*k2; RN(6,2)=(e2*r1-q2*r3)*k2; RN(6,3)=(q2*r2-w2*r1)*k2;
RN(7,1)=(w3*r3-e3*r2)*k3; RN(7,2)=(e3*r1-q3*r3)*k3; RN(7,3)=(q3*r2-w3*r1)*k3;
RN(8,1)=(w4*r3-e4*r2)*k4; RN(8,2)=(e4*r1-q4*r3)*k4; RN(8,3)=(q4*r2-w4*r1)*k4;
%Ey


n1=lz(1)/8*(1-a)*(1-b);
n2=lz(2)/8*(1+a)*(1-b);
n3=lz(3)/8*(1-a)*(1+b);
n4=lz(4)/8*(1+a)*(1+b);

N(9,1)=n1*t1; N(9,2)=n1*t2;  N(9,3)=n1*t3;
N(10,1)=n2*t1; N(10,2)=n2*t2;  N(10,3)=n2*t3;
N(11,1)=n3*t1; N(11,2)=n3*t2;  N(11,3)=n3*t3;
N(12,1)=n4*t1; N(12,2)=n4*t2;  N(12,3)=n4*t3;


q1=-s1-r1+a*r1+b*s1;
q2=s1-r1-a*r1-b*s1;
q3=-s1+r1-a*r1-b*s1;
q4=s1+r1+a*r1+b*s1;

w1=-s2-r2+a*r2+b*s2;
w2=s2-r2-a*r2-b*s2;
w3=-s2+r2-a*r2-b*s2;
w4=s2+r2+a*r2+b*s2;

e1=-s3-r3+a*r3+b*s3;
e2=s3-r3-a*r3-b*s3;
e3=-s3+r3-a*r3-b*s3;
e4=s3+r3+a*r3+b*s3;

% q w e
% t1 t2 t3
k1=lz(1)/8; k2=lz(2)/8; k3=lz(3)/8; k4=lz(4)/8;
RN(9,1)=(w1*t3-e1*t2)*k1; RN(9,2)=(e1*t1-q1*t3)*k1; RN(9,3)=(q1*t2-w1*t1)*k1;
RN(10,1)=(w2*t3-e2*t2)*k2; RN(10,2)=(e2*t1-q2*t3)*k2; RN(10,3)=(q2*t2-w2*t1)*k2;
RN(11,1)=(w3*t3-e3*t2)*k3; RN(11,2)=(e3*t1-q3*t3)*k3; RN(11,3)=(q3*t2-w3*t1)*k3;
RN(12,1)=(w4*t3-e4*t2)*k4; RN(12,2)=(e4*t1-q4*t3)*k4; RN(12,3)=(q4*t2-w4*t1)*k4;

%Ez



e1=-(1-b).*(1-c)*0.125;
e2=(1-b).*(1-c)*0.125;
e3=(1+b).*(1-c)*0.125;
e4=-(1+b).*(1-c)*0.125;
e5=-(1-b).*(1+c)*0.125;
e6=(1-b).*(1+c)*0.125;
e7=(1+b).*(1+c)*0.125;
e8=-(1+b).*(1+c)*0.125;


y1=-(1-a)*(1-c)*0.125;
y2=-(1+a)*(1-c)*0.125;
y3=(1+a)*(1-c)*0.125;
y4=(1-a)*(1-c)*0.125;
y5=-(1-a)*(1+c)*0.125;
y6=-(1+a)*(1+c)*0.125;
y7=(1+a)*(1+c)*0.125;
y8=(1-a)*(1+c)*0.125;


u1=-(1-a).*(1-b)*0.125;
u2=-(1+a).*(1-b)*0.125;
u3=-(1+a).*(1+b)*0.125;
u4=-(1-a).*(1+b)*0.125;
u5=(1-a).*(1-b)*0.125;
u6=(1+a).*(1-b)*0.125;
u7=(1+a).*(1+b)*0.125;
u8=(1-a).*(1+b)*0.125;

M(1,1)=e1*s1+y1*r1+u1*t1;
M(2,1)=e2*s1+y2*r1+u2*t1;
M(3,1)=e3*s1+y3*r1+u3*t1;
M(4,1)=e4*s1+y4*r1+u4*t1;
M(5,1)=e5*s1+y5*r1+u5*t1;
M(6,1)=e6*s1+y6*r1+u6*t1;
M(7,1)=e7*s1+y7*r1+u7*t1;
M(8,1)=e8*s1+y8*r1+u8*t1;

M(1,2)=e1*s2+y1*r2+u1*t2;
M(2,2)=e2*s2+y2*r2+u2*t2;
M(3,2)=e3*s2+y3*r2+u3*t2;
M(4,2)=e4*s2+y4*r2+u4*t2;
M(5,2)=e5*s2+y5*r2+u5*t2;
M(6,2)=e6*s2+y6*r2+u6*t2;
M(7,2)=e7*s2+y7*r2+u7*t2;
M(8,2)=e8*s2+y8*r2+u8*t2;

M(1,3)=e1*s3+y1*r3+u1*t3;
M(2,3)=e2*s3+y2*r3+u2*t3;
M(3,3)=e3*s3+y3*r3+u3*t3;
M(4,3)=e4*s3+y4*r3+u4*t3;
M(5,3)=e5*s3+y5*r3+u5*t3;
M(6,3)=e6*s3+y6*r3+u6*t3;
M(7,3)=e7*s3+y7*r3+u7*t3;
M(8,3)=e8*s3+y8*r3+u8*t3;

end

